using System.Collections;
using System.Collections.Generic;
using UnityEngine;

public class MalwareController : MonoBehaviour
{
    public static MalwareSave malwareSave;

    public ComputerManager computerManager;

    public string[] virus_QuestDetail;

    public string[] adware_QuestDetail;

    public string[] trojan_QuestDetail;

    public string TriggerNPC(int index)
    {
        Target NPC = (Target) index;

        int malwareIndex;
        string questDetail;
        MalwareObject malware;
        (malwareIndex, malware) = MalwareManager.GetRandomMalware();
        malwareSave =
            new MalwareSave {
                dayLeft = 4,
                questTarget = NPC,
                malwareName = malware.name,
                malwareType = malware.detail,
                dictIndex = malwareIndex
            };
        computerManager.AddMalwareToCom (NPC, malwareIndex);
        switch (malware.detail)
        {
            case MalwareType.Virus:
                SetVirus (NPC);
                questDetail =
                    virus_QuestDetail[Random
                        .Range(0, virus_QuestDetail.Length - 1)];
                break;
            case MalwareType.Adware:
                SetAdware (NPC);
                questDetail =
                    adware_QuestDetail[Random
                        .Range(0, adware_QuestDetail.Length - 1)];
                break;
            case MalwareType.Trojan:
                SetTrojan (NPC);
                questDetail =
                    trojan_QuestDetail[Random
                        .Range(0, virus_QuestDetail.Length - 1)];
                break;
            default:
                questDetail = "";
                break;
        }

        NPCcontroller.TriggerNPCQuest(NPC, questDetail, Scenario.Malware);
        Debug
            .Log("Malware scenario trigger: " +
            malware.name +
            " " +
            malware.detail +
            " NPC: " +
            NPC);
        return JsonUtility.ToJson(malwareSave);
    }

    private void SetVirus(Target target)
    {
        computerManager.SystemOverload (target);
        computerManager.DiskOverload (target);
        computerManager.SetComputerBehavior(target, true, true);
    }

    private void SetTrojan(Target target)
    {
        computerManager.SystemOverload (target);
        computerManager.SetComputerBehavior(target, true, true);
    }

    private void SetAdware(Target target)
    {
        computerManager.SetComputerBehavior(target, false, false);
    }

    public (bool, string) UpdateScenarioState()
    {
        malwareSave.dayLeft--;
        if (malwareSave.dayLeft <= 0)
        {
            return (false, JsonUtility.ToJson(malwareSave));
        }
        return (true, JsonUtility.ToJson(malwareSave));
    }

    public void SetMalwareScenarioState(string detail)
    {
        malwareSave = JsonUtility.FromJson<MalwareSave>(detail);
        string questDetail;
        int malwareIndex = malwareSave.dictIndex;
        Target NPC = malwareSave.questTarget;
        Debug.Log("Npc target update " + NPC);

        computerManager.AddMalwareToCom (NPC, malwareIndex);
        switch (malwareSave.malwareType)
        {
            case MalwareType.Virus:
                SetVirus (NPC);
                questDetail =
                    virus_QuestDetail[Random
                        .Range(0, virus_QuestDetail.Length - 1)];
                break;
            case MalwareType.Adware:
                SetAdware (NPC);
                questDetail =
                    adware_QuestDetail[Random
                        .Range(0, adware_QuestDetail.Length - 1)];
                break;
            case MalwareType.Trojan:
                SetTrojan (NPC);
                questDetail =
                    trojan_QuestDetail[Random
                        .Range(0, virus_QuestDetail.Length - 1)];
                break;
            default:
                questDetail = "";
                break;
        }

        NPCcontroller.TriggerNPCQuest(NPC, questDetail, Scenario.Malware);
        Debug
            .Log("Continue Malware sce: " +
            malwareSave.malwareName +
            " " +
            malwareSave.malwareType);
    }

    public void InvokeScenarioFailure()
    {
        NPCcontroller.DisableAllNPC();
        computerManager.PurgeMalwareOnCom(malwareSave.questTarget);
        ScenarioManager.InvokeScenarioFailed(JsonUtility.ToJson(malwareSave));
    }

    public void InvokeScenarioSuccess(bool useAntivirus)
    {
        NPCcontroller.DisableAllNPC();
        computerManager.PurgeMalwareOnCom(malwareSave.questTarget);
        ScenarioManager.InvokeScenarioSuccess(JsonUtility.ToJson(malwareSave));
    }
}

public class MalwareSave
{
    public int dayLeft;

    public Target questTarget;

    public string malwareName;

    public MalwareType malwareType;

    public int dictIndex;
}
